---
layout:     post
title:      高性能JavaScript--快速响应的用户界面
date:       2015-02-12 21:47:29
summary:    有一句话很有道理：“如果JavaScript运行了整整几秒钟，那么很有可能是你做错了什么......”，如果界面在100毫秒内响应用户输入，用户会认为自己在“直接操作界面中的对象”。超过100毫秒意味着用户感觉自己与界面失去了联系。JavaScript和用户界面更新在同一个进程中运行，因此一次只能处理一件事情。这意味着当JavaScript代码在运行时，用户界面不能响应输入，反之亦然。高效地管理UI线程就是要确保JavaScript不能运行太长时间，以免影响用户体验。管理好JavaScript的运行时间对Web应用的性能非常重要。
categories: JavaScript  学习笔记
---

有一句话很有道理：“如果JavaScript运行了整整几秒钟，那么很有可能是你做错了什么......”，如果界面在100毫秒内响应用户输入，用户会认为自己在“直接操作界面中的对象”。超过100毫秒意味着用户感觉自己与界面失去了联系。JavaScript和用户界面更新在同一个进程中运行，因此一次只能处理一件事情。这意味着当JavaScript代码在运行时，用户界面不能响应输入，反之亦然。高效地管理UI线程就是要确保JavaScript不能运行太长时间，以免影响用户体验。管理好JavaScript的运行时间对Web应用的性能非常重要。

###浏览器UI线程

####定义
共用于执行JavaScript和更新用户界面的进程通常被称为“浏览器UI线程”（尽管对所有浏览器来说，称为“线程”不一定准确）。

####工作原理
UI线程的工作基于一个简单的队列系统，任务会保存到队列中直至进程空闲。一旦空闲，队列中的下一个任务就被重新提取出来并运行，这些任务要么是运行JavaScript代码，要么是执行UI更新，包括重绘和重排。也许这个进程中最有趣的部分在于每一次输入可能会导致一个或多个任务被加到队列。

####优化
当所有的UI线程任务都执行完毕，进程进入空闲状态，并等待更多任务加入队列。**空闲状态是理想的**，因为用户所有的交互都会立即触发UI更新。如果用户试图在任务运行期间于页面交互，不紧没有即时的UI更新，甚至可能新的UI更新不会被创建并不会被加到队列。事实上，太多事浏览器在JavaScript运行时会停止把新任务加到UI线程中，也就是说**JavaScript任务必须尽快结束**，以避免对用户体验造成不良影响。

###浏览器限制
浏览器为了确保某些恶意代码不能通过永不停止的密集操作锁住用户的浏览器或计算机，因此浏览器限制了JavaScript的运行时间。
此类限制分两种：调用栈大小限制（记录脚本开始以来执行语句的数量）和长时间运行脚本限制（记录脚本执行的总时长）。

##使用定时器让出时间片段
尽管你尽了最大努力，但难免会有一些复杂的JavaScript任务不能在100毫秒或者更短的时间完成。这个时候，最理想的方法是**让出UI线程的控制权，使得UI可以更新，

####使用定时器
定时器与UI线程的交互有助于把长时间运行的脚本拆分成更短的片段，调用setTimeOut()或setInterval()会告诉JavaScript先等待一段时间，然后再添加一个任务到UI队列。